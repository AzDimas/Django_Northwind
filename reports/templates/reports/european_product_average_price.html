<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Hide content initially */
        .main-content {
            display: none;
        }
        /* Loading spinner styling */
        #loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        .permission-error {
            display: none;
        }
    </style>
    <script>
    // Logout function
    async function handleLogout() {
        const token = localStorage.getItem("authToken");
        if (!token) return redirectToLogin();

        try {
            await fetch("/auth/logout/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Token " + token
                }
            });
            clearSessionAndRedirect();
        } catch (error) {
            console.error("Logout error:", error);
            clearSessionAndRedirect();
        }
    }

    // Verify access
    async function verifyAccess() {
        const token = localStorage.getItem("authToken");
        if (!token) return redirectToLogin();

        try {
            const response = await fetch("/api/verify-token/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Token " + token
                },
                body: JSON.stringify({
                    requested_path: window.location.pathname,
                    required_permission: "reports.view_europeanproductaverageprice"
                })
            });

            if (response.status === 401) {
                clearSessionAndRedirect();
                return false;
            }
            
            if (response.status === 403) {
                showPermissionError();
                return false;
            }

            const data = await response.json();
            if (!data?.valid) {
                showPermissionError();
                return false;
            }

            return true;
        } catch (error) {
            console.error("Verification error:", error);
            showPermissionError();
            return false;
        }
    }

    // Helper functions
    function clearSessionAndRedirect() {
        localStorage.removeItem("authToken");
        redirectToLogin();
    }

    function redirectToLogin() {
        window.location.href = `/login?next=${encodeURIComponent(window.location.pathname)}`;
    }

    function showPermissionError() {
        document.getElementById('loading-spinner').style.display = 'none';
        document.querySelector('.permission-error').style.display = 'block';
    }

    // Initialize
    document.addEventListener("DOMContentLoaded", async function() {
        document.getElementById('loading-spinner').style.display = 'block';
        
        const hasAccess = await verifyAccess();
        if (hasAccess) {
            document.getElementById('loading-spinner').style.display = 'none';
            document.querySelector('.main-content').style.display = 'block';
        }
    });
    </script>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loading-spinner" class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>

    <!-- Permission Error Message -->
    <div class="permission-error alert alert-danger text-center mt-5 mx-3">
        <h4 class="alert-heading">Akses Ditolak</h4>
        <p>Anda tidak memiliki izin untuk mengakses halaman ini.</p>
        <a href="{% url 'home' %}" class="btn btn-secondary">Kembali ke Dasbor</a>
    </div>

    <!-- Navbar (always visible) -->
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'home' %}">Northwind DW Dashboard</a>
            <button class="btn btn-outline-light" onclick="handleLogout()">Logout</button>
        </div>
    </nav>

    <!-- Main Content (hidden until verified) -->
    <main class="container mt-4 main-content">
        <h1 class="mb-4">{{ title }}</h1>

        <table class="table table-striped">
            <thead class="table-dark">
                <tr>
                    <th>Country Name</th>
                    <th>Average Unit Price</th>
                </tr>
            </thead>
            <tbody>
                {% for item in data %}
                <tr>
                    <td>{{ item.country }}</td>
                    <td>${{ item.average_unit_price|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="2" class="text-center">Data tidak ditemukan.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <a href="{% url 'home' %}" class="btn btn-secondary mt-3">Kembali ke Dasbor</a>
    </main>
</body>
</html>