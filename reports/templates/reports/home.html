<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .permission-denied {
            display: none; /* Awalnya sembunyikan semua menu */
        }
    </style>
    <script>
        // Cek token di localStorage
        const token = localStorage.getItem("authToken");
        if (!token) {
            window.location.href = "{% url 'login_page' %}";
        }

        // Fungsi untuk verifikasi token dan permission
        async function verifyAccess() {
            try {
                const res = await fetch("/api/verify-token/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Token " + token
                    }
                });

                if (res.status === 401) {
                    alert("Sesi login habis. Silakan login ulang.");
                    localStorage.removeItem("authToken");
                    window.location.href = "{% url 'login_page' %}";
                    return false;
                }
                
                const data = await res.json();
                if (data && data.valid) {
                    // Tampilkan menu sesuai permission
                    showAllowedMenus(data.permissions);
                    return true;
                }
                return false;
            } catch (err) {
                console.error("Error verifikasi token:", err);
                return false;
            }
        }

        // Fungsi untuk menampilkan menu yang diizinkan
        function showAllowedMenus(permissions) {
            const menuItems = {
                'usa_employee': 'reports.view_usaemployeephonebook',
                'territories': 'reports.view_territorieswithallemployees',
                'depleted': 'reports.view_depletedcategory',
                'fragile': 'reports.view_fragileproducts',
                'european': 'reports.view_europeanproductaverageprice',
                'shipper': 'reports.view_favouriteshipper',
                'region': 'reports.view_totalemployeeineveryregion',
                'general': 'reports.view_generalphonebook'
            };

            for (const [menuId, perm] of Object.entries(menuItems)) {
                const menuElement = document.getElementById(menuId);
                if (menuElement && permissions.includes(perm)) {
                    menuElement.classList.remove('permission-denied');
                }
            }
        }

        // Fungsi untuk logout
        async function handleLogout() {
            try {
                await fetch("{% url 'api-logout' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Token " + token
                    }
                });
                
                localStorage.removeItem("authToken");
                window.location.href = "{% url 'login_page' %}";
            } catch (error) {
                console.error("Error saat logout:", error);
                localStorage.removeItem("authToken");
                window.location.href = "{% url 'login_page' %}";
            }
        }

        document.addEventListener("DOMContentLoaded", verifyAccess);
    </script>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Northwind DW Dashboard</a>
        <button class="btn btn-outline-light" onclick="handleLogout()">Logout</button>
    </div>
</nav>

<main class="container mt-4">
    <h1 class="mb-4">ðŸ“Š Laporan Analitik</h1>
    <p>Pilih laporan yang ingin Anda lihat. Data ini dihasilkan dari Data Warehouse.</p>

    <div class="list-group">
        <a id="usa_employee" href="{% url 'usa_employee_phone_book_html' %}" class="list-group-item list-group-item-action permission-denied">USA Employee Phone Book</a>
        <a id="territories" href="{% url 'territories_with_all_employees_html' %}" class="list-group-item list-group-item-action permission-denied">Territories With All Employees</a>
        <a id="depleted" href="{% url 'depleted_category_html' %}" class="list-group-item list-group-item-action permission-denied">Depleted Category</a>
        <a id="fragile" href="{% url 'fragile_products_html' %}" class="list-group-item list-group-item-action permission-denied">Fragile Products</a>
        <a id="european" href="{% url 'european_product_avg_price_html' %}" class="list-group-item list-group-item-action permission-denied">European Product Average Price</a>
        <a id="shipper" href="{% url 'favourite_shipper_html' %}" class="list-group-item list-group-item-action permission-denied">Favourite Shipper</a>
        <a id="region" href="{% url 'total_employee_in_every_region_html' %}" class="list-group-item list-group-item-action permission-denied">Total Employee In Every Region</a>
        <a id="general" href="{% url 'general_phone_book_html' %}" class="list-group-item list-group-item-action permission-denied">General Phone Book</a>
    </div>
</main>
</body>
</html>