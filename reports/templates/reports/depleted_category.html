<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Hide content initially */
        .content-container {
            display: none;
        }
        /* Loading spinner styling */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
    <script>
    // Logout function
    async function handleLogout() {
        const token = localStorage.getItem("authToken");
        if (!token) return redirectToLogin();

        try {
            await fetch("/auth/logout/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Token " + token
                }
            });
            clearAuthAndRedirect();
        } catch (error) {
            console.error("Logout error:", error);
            clearAuthAndRedirect();
        }
    }

    // Verify access
    async function verifyAccess() {
        const token = localStorage.getItem("authToken");
        const currentPath = window.location.pathname;

        if (!token) {
            redirectToLogin(currentPath);
            return false;
        }

        try {
            const response = await fetch("/api/verify-token/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Token " + token
                },
                body: JSON.stringify({
                    requested_path: currentPath,
                    required_permission: "reports.view_depletedcategory"
                })
            });

            if (response.status === 401) {
                clearAuthAndRedirect(currentPath);
                return false;
            }
            
            if (response.status === 403) {
                window.location.href = "/forbidden";
                return false;
            }

            const data = await response.json();
            return data?.valid || false;
        } catch (error) {
            console.error("Verification error:", error);
            window.location.href = "/forbidden";
            return false;
        }
    }

    // Helper functions
    function clearAuthAndRedirect(path = "") {
        localStorage.removeItem("authToken");
        redirectToLogin(path);
    }

    function redirectToLogin(path = "") {
        window.location.href = `/login?next=${encodeURIComponent(path || window.location.pathname)}`;
    }

    // Initialize
    document.addEventListener("DOMContentLoaded", async function() {
        document.getElementById('loading-overlay').style.display = 'flex';
        
        const hasAccess = await verifyAccess();
        if (hasAccess) {
            document.getElementById('loading-overlay').style.display = 'none';
            document.querySelector('.content-container').style.display = 'block';
        }
    });
    </script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Navbar (always visible) -->
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'home' %}">Northwind DW Dashboard</a>
            <button class="btn btn-outline-light" onclick="handleLogout()">Logout</button>
        </div>
    </nav>

    <!-- Content Container (hidden until verified) -->
    <div class="content-container">
        <main class="container mt-4">
            <h1 class="mb-4">{{ title }}</h1>

            {% if perms.reports.view_depletedcategory %}
            <table class="table table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Category Name</th>
                        <th>Total Units In Stock</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data %}
                    <tr>
                        <td>{{ item.category_name }}</td>
                        <td>{{ item.total_units_in_stock }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" class="text-center">Data tidak ditemukan.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="alert alert-danger" role="alert">
                Anda tidak memiliki izin untuk melihat laporan ini.
            </div>
            {% endif %}

            <a href="{% url 'home' %}" class="btn btn-secondary mt-3">Kembali ke Dasbor</a>
        </main>
    </div>
</body>
</html>